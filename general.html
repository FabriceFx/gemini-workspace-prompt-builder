<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Outil de création de prompts IA bilingue.">
    <title>Prompt Builder - FR/EN</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // Configuration correcte : Google Sans Flex en priorité
                        sans: ['"Google Sans Flex"', '"Outfit"', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace'],
                    },
                    colors: {
                        md: {
                            sys: {
                                primary: '#0b57d0',
                                surface: '#f0f4f9',
                                on_surface: '#1f1f1f',
                            }
                        }
                    }
                }
            }
        }
    </script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght@8..144,100..1000&family=Outfit:wght@300;400;500;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* Base & Reset */
        body { 
            font-family: 'Google Sans Flex', 'Outfit', sans-serif; 
            background-color: #f0f4f9; 
            overscroll-behavior-y: none; 
        }
        
        /* Material 3 Input Style */
        .m3-field {
            position: relative;
            background-color: #f0f4f9;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #747775;
            transition: all 0.2s;
        }
        .m3-field:focus-within { background-color: #e8edfa; border-bottom: 2px solid #0b57d0; }
        .m3-input {
            width: 100%; background: transparent; border: none; padding: 24px 16px 8px 16px;
            outline: none; font-size: 1rem; color: #1f1f1f; line-height: 1.5;
            /* Important pour hériter de Google Sans Flex dans les inputs */
            font-family: inherit; 
        }
        .m3-input:not(:focus)::placeholder { opacity: 0; transition: opacity 0.2s; }
        .m3-label {
            position: absolute; left: 16px; top: 18px; font-size: 1rem; color: #444746;
            pointer-events: none; transition: 0.2s ease all; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .m3-input:focus ~ .m3-label, .m3-input:not(:placeholder-shown) ~ .m3-label {
            top: 6px; font-size: 0.75rem; color: #0b57d0; font-weight: 500;
        }

        /* Checkbox */
        .m3-checkbox-container { display: flex; align-items: center; cursor: pointer; padding: 8px 0; }
        .m3-checkbox {
            appearance: none; background-color: #fff; margin: 0; font: inherit; color: currentColor;
            width: 1.15em; height: 1.15em; border: 2px solid #747775; border-radius: 2px;
            display: grid; place-content: center; margin-right: 12px; transition: 0.2s all;
        }
        .m3-checkbox::before {
            content: ""; width: 0.65em; height: 0.65em; transform: scale(0);
            transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white;
            transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .m3-checkbox:checked { background-color: #0b57d0; border-color: #0b57d0; }
        .m3-checkbox:checked::before { transform: scale(1); }
        
        /* Syntax & Scroll */
        .json-key { color: #9a0036; } .json-string { color: #00600f; } .json-number { color: #1a237e; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #c4c7c5; border-radius: 4px; }
        .tab-active { background-color: #d3e3fd; color: #041e49; font-weight: 600; }
        .tab-inactive { background-color: transparent; color: #444746; }
        
        /* Mobile Nav Active State */
        .mobile-nav-btn.active { color: #0b57d0; background-color: #e8edfa; }
    </style>
</head>

<body class="h-dvh w-screen overflow-hidden flex flex-col md:flex-row text-[#1f1f1f]">

    <aside id="panel-editor" class="w-full md:w-[500px] flex-col h-full bg-white border-r border-[#c4c7c5] z-20 shadow-lg flex">
        
        <header class="p-4 flex items-center justify-between border-b border-gray-100 flex-none bg-white z-10">
            <h1 class="text-xl font-normal tracking-tight text-[#444746]">Prompt<span class="font-medium text-md-sys-primary">Builder</span></h1>
            <div class="flex items-center gap-2">
                <button onclick="toggleLanguage()" class="text-sm font-medium text-md-sys-primary hover:bg-blue-50 px-3 py-1 rounded-full transition border border-blue-100">
                    <span id="lang-display">FR</span> <i class="fas fa-globe ml-1"></i>
                </button>
                <button onclick="resetForm()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full transition" id="btn-reset" aria-label="Effacer">
                    <i class="fas fa-eraser"></i>
                </button>
            </div>
        </header>

        <div class="flex-grow overflow-y-auto p-4 space-y-6 pb-24 md:pb-4">
            <div class="m3-field">
                <input type="text" id="role" class="m3-input" placeholder=" " oninput="updateOutput()">
                <label class="m3-label" id="lbl-role" for="role">1. Persona (Rôle)</label>
            </div>
            <div class="m3-field">
                <textarea id="task" rows="3" class="m3-input resize-none" placeholder=" " oninput="updateOutput()"></textarea>
                <label class="m3-label" id="lbl-task" for="task">2. Tâche (Mission)</label>
            </div>
            <div class="m3-field">
                <textarea id="context" rows="3" class="m3-input resize-none" placeholder=" " oninput="updateOutput()"></textarea>
                <label class="m3-label" id="lbl-context" for="context">3. Contexte</label>
            </div>

            <div class="space-y-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1" id="lbl-header-format">4. Format & Contraintes</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="m3-field rounded-t-lg">
                        <select id="tone" class="m3-input pt-6 bg-transparent" onchange="updateOutput()"></select>
                        <label class="m3-label" id="lbl-tone" for="tone">Ton</label>
                        <i class="fas fa-caret-down absolute right-3 top-6 text-gray-500 pointer-events-none"></i>
                    </div>
                    <div class="m3-field rounded-t-lg">
                        <select id="format" class="m3-input pt-6 bg-transparent" onchange="updateOutput()"></select>
                        <label class="m3-label" id="lbl-format" for="format">Format</label>
                        <i class="fas fa-caret-down absolute right-3 top-6 text-gray-500 pointer-events-none"></i>
                    </div>
                </div>
                <div class="m3-field">
                    <input type="text" id="constraints" class="m3-input" placeholder=" " oninput="updateOutput()">
                    <label class="m3-label" id="lbl-constraints" for="constraints">Autres contraintes</label>
                </div>
            </div>

            <div class="space-y-2">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1" id="lbl-header-files">5. Pièces jointes</h3>
                <div class="border border-dashed border-[#747775] rounded-xl p-4 bg-white relative" id="drop-zone">
                    <input type="file" id="file-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple onchange="handleFiles(this.files)">
                    <div class="text-center pointer-events-none">
                        <i class="fas fa-cloud-upload-alt text-md-sys-primary text-xl mb-1"></i>
                        <p class="text-sm text-[#444746]" id="txt-dropzone">Glisser ou <span class="text-md-sys-primary font-medium">Parcourir</span></p>
                    </div>
                </div>
                <div id="file-list" class="flex flex-wrap gap-2"></div>
                <div id="file-warning" class="hidden warning-banner bg-orange-50 border border-orange-200 rounded-lg p-3 flex gap-3 items-start mt-2">
                    <i class="fas fa-exclamation-triangle text-orange-500 mt-0.5 text-sm"></i>
                    <p class="text-xs text-orange-800 leading-relaxed" id="txt-file-warning">
                        Le copier-coller ne transfère pas les fichiers.
                    </p>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1" id="lbl-header-instructions">6. Instructions</h3>
                    <button onclick="addInstruction()" class="text-md-sys-primary hover:bg-blue-50 w-6 h-6 rounded-full flex items-center justify-center transition"><i class="fas fa-plus text-xs"></i></button>
                </div>
                <div id="instructions-container" class="space-y-2"></div>
            </div>

            <div class="pt-2 border-t border-gray-100">
                <label class="m3-checkbox-container">
                    <input type="checkbox" id="feedback-loop" class="m3-checkbox" onchange="updateOutput()">
                    <span class="text-sm text-[#444746] font-medium" id="lbl-feedback">Activer la boucle de feedback</span>
                </label>
                <p class="text-xs text-gray-400 pl-8" id="txt-feedback-help">Demande à l'IA de poser des questions de clarification avant de répondre.</p>
            </div>

            <div class="md:hidden pt-8 pb-4 text-center border-t border-gray-100 mt-4">
                <p class="text-xs text-gray-500 mb-2"><span class="lbl-developed-mobile">Développé par</span> <strong>Fabrice Faucheux</strong></p>
                <a href="https://paypal.me/FFaucheux?country.x=FR&locale.x=fr_FR" target="_blank" class="text-xs inline-flex items-center gap-2 px-4 py-2 bg-[#003087] text-white rounded-full hover:bg-[#001c64] transition shadow-sm font-medium">
                    <i class="fab fa-paypal"></i> <span class="lbl-tip-mobile">M'offrir un pourboire</span>
                </a>
            </div>

        </div>

        <footer class="hidden md:block flex-none p-4 border-t border-gray-200 bg-gray-50 text-center">
             <p class="text-xs text-gray-500 mb-2"><span id="lbl-developed">Développé par</span> <strong class="text-gray-700">Fabrice Faucheux</strong></p>
             <a href="https://paypal.me/FFaucheux?country.x=FR&locale.x=fr_FR" target="_blank" class="text-xs inline-flex items-center gap-2 px-4 py-2 bg-[#003087] text-white rounded-full hover:bg-[#001c64] transition shadow-sm font-medium">
                <i class="fab fa-paypal"></i> <span id="lbl-tip">M'offrir un pourboire</span>
            </a>
        </footer>
    </aside>


    <main id="panel-preview" class="hidden md:flex flex-grow flex-col h-full bg-md-sys-surface overflow-hidden relative pb-20 md:pb-0">
        
        <div class="flex-none px-4 pt-4 pb-2 flex justify-between items-end flex-wrap gap-2">
            <div class="flex bg-white rounded-full p-1 shadow-sm border border-gray-200">
                <button onclick="switchTab('markdown')" id="tab-btn-markdown" class="tab-active px-4 py-2 rounded-full text-xs md:text-sm transition-all flex items-center gap-2">
                    <i class="fab fa-markdown"></i> <span id="lbl-preview">Aperçu</span>
                </button>
                <button onclick="switchTab('json')" id="tab-btn-json" class="tab-inactive px-4 py-2 rounded-full text-xs md:text-sm transition-all flex items-center gap-2">
                    <i class="fas fa-code"></i> JSON
                </button>
            </div>
            
            <button onclick="copyCurrentContent()" class="bg-md-sys-primary hover:bg-blue-700 text-white px-5 py-2.5 rounded-full shadow-elevation-1 transition-all flex items-center gap-2 text-sm font-medium">
                <i class="far fa-copy"></i>
                <span id="copy-btn-text">Copier</span>
            </button>
        </div>

        <div class="flex-grow p-4 overflow-hidden">
            <div class="h-full w-full bg-white rounded-3xl border border-white shadow-sm overflow-hidden flex flex-col relative">
                
                <div id="view-markdown" class="p-6 md:p-8 overflow-y-auto h-full prose prose-slate max-w-none font-sans text-gray-700 text-sm md:text-base">
                    <div class="flex items-center gap-2 text-gray-400 mb-4 opacity-50 select-none">
                        <i class="fas fa-sparkles"></i> <span id="lbl-generated">Aperçu généré</span>
                    </div>
                    <div id="markdown-content" class="whitespace-pre-wrap leading-relaxed"></div>
                </div>

                <div id="view-json" class="hidden p-0 h-full bg-[#1e1e1e] overflow-auto">
                    <pre class="p-6 text-xs md:text-sm font-mono leading-relaxed text-[#e0e0e0]"><code id="json-content"></code></pre>
                </div>

            </div>
        </div>
    </main>


    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around p-2 z-50 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="showMobileTab('editor')" id="nav-btn-editor" class="mobile-nav-btn active flex flex-col items-center gap-1 p-2 rounded-xl flex-1 transition text-gray-500">
            <i class="fas fa-pen"></i>
            <span class="text-xs font-medium" id="lbl-nav-edit">Éditer</span>
        </button>
        <div class="w-px bg-gray-200 my-1"></div>
        <button onclick="showMobileTab('preview')" id="nav-btn-preview" class="mobile-nav-btn flex flex-col items-center gap-1 p-2 rounded-xl flex-1 transition text-gray-500">
            <i class="fas fa-eye"></i>
            <span class="text-xs font-medium" id="lbl-nav-view">Résultat</span>
        </button>
    </nav>


    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-[#323232] text-white px-4 py-3 rounded shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-[60] flex items-center gap-3 w-max">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="txt-toast">Copié !</span>
    </div>

    <script>
        // --- TRANSLATIONS ---
        const translations = {
            fr: {
                lbl_role: "1. Persona (Rôle)", ph_role: "Ex: Expert Marketing...",
                lbl_task: "2. Tâche (Mission)", ph_task: "Ex: Rédiger un email...",
                lbl_context: "3. Contexte", ph_context: "Contexte du projet...",
                lbl_header_format: "4. Format & Contraintes", lbl_tone: "Ton", lbl_format: "Format",
                lbl_constraints: "Autres contraintes", ph_constraints: "Ex: Court, concis...",
                lbl_header_files: "5. Pièces jointes", txt_dropzone: "Glisser ou <span class='text-md-sys-primary'>Parcourir</span>",
                txt_file_warning: "Le copier-coller ne transfère pas les fichiers.",
                lbl_header_instructions: "6. Instructions", 
                lbl_feedback: "Activer la boucle de feedback", 
                txt_feedback_help: "Demande à l'IA de poser des questions de clarification avant de répondre.",
                lbl_preview: "Aperçu", lbl_generated: "Aperçu généré", btn_copy: "Copier", txt_toast: "Copié !",
                lbl_developed: "Développé par", lbl_tip: "M'offrir un pourboire",
                // Mobile Nav
                lbl_nav_edit: "Éditer", lbl_nav_view: "Résultat",
                // Prompt Strings
                prompt_you_are: "Tu es un", prompt_task: "Ta mission est de :", prompt_context: "Contexte :",
                prompt_tone: "Ton :", prompt_format: "Format :", prompt_constraints: "Contraintes :",
                prompt_files: "Fichiers joints :", prompt_file_item: "[Fichier : ", prompt_instructions: "Instructions :",
                prompt_feedback: "\n\n---\n**IMPORTANT :** Avant de générer la réponse finale, pose-moi des questions si tu as besoin de précisions ou de contexte supplémentaire."
            },
            en: {
                lbl_role: "1. Persona (Role)", ph_role: "Ex: Marketing Expert...",
                lbl_task: "2. Task (Mission)", ph_task: "Ex: Write an email...",
                lbl_context: "3. Context", ph_context: "Project context...",
                lbl_header_format: "4. Format & Constraints", lbl_tone: "Tone", lbl_format: "Format",
                lbl_constraints: "Other Constraints", ph_constraints: "Ex: Short, concise...",
                lbl_header_files: "5. Attachments", txt_dropzone: "Drag or <span class='text-md-sys-primary'>Browse</span>",
                txt_file_warning: "Copy/paste doesn't transfer files.",
                lbl_header_instructions: "6. Instructions", 
                lbl_feedback: "Enable Feedback Loop",
                txt_feedback_help: "Ask the AI to ask clarifying questions before answering.",
                lbl_preview: "Preview", lbl_generated: "Generated Preview", btn_copy: "Copy", txt_toast: "Copied!",
                lbl_developed: "Developed by", lbl_tip: "Leave a tip",
                // Mobile Nav
                lbl_nav_edit: "Edit", lbl_nav_view: "Result",
                // Prompt Strings
                prompt_you_are: "You are a", prompt_task: "Your task is to:", prompt_context: "Context:",
                prompt_tone: "Tone:", prompt_format: "Format:", prompt_constraints: "Constraints:",
                prompt_files: "Attachments:", prompt_file_item: "[File: ", prompt_instructions: "Instructions:",
                prompt_feedback: "\n\n---\n**IMPORTANT:** Before generating the final response, ask me questions if you need clarification or additional context."
            }
        };

        // --- FULL OPTIONS RESTORED ---
        const toneOptions = [
            { key: "", fr: "Par défaut", en: "Default" },
            { key: "professional", fr: "Professionnel & Neutre", en: "Professional & Neutral" },
            { key: "formal", fr: "Formel & Officiel", en: "Formal & Official" },
            { key: "informal", fr: "Informel & Casual", en: "Informal & Casual" },
            { key: "empathetic", fr: "Bienveillant & Empathique", en: "Empathetic & Kind" },
            { key: "direct", fr: "Direct & Concis", en: "Direct & Concise" },
            { key: "confident", fr: "Confiant & Ferme", en: "Confident & Firm" },
            { key: "persuasive", fr: "Commercial & Persuasif", en: "Persuasive & Sales-oriented" },
            { key: "creative", fr: "Créatif & Original", en: "Creative & Original" },
            { key: "technical", fr: "Technique & Précis", en: "Technical & Precise" },
            { key: "inspiring", fr: "Inspirant & Optimiste", en: "Inspiring & Optimistic" },
            { key: "eli5", fr: "Vulgarisé (ELI5)", en: "Simplified (ELI5)" }
        ];

        const formatOptions = [
            { key: "", fr: "Texte libre", en: "Free Text" },
            { key: "bullet", fr: "Liste à puces", en: "Bullet Points" },
            { key: "table", fr: "Tableau structuré", en: "Structured Table" },
            { key: "email", fr: "Email complet", en: "Full Email" },
            { key: "checklist", fr: "Checklist (Pas à pas)", en: "Checklist (Step-by-step)" },
            { key: "blog", fr: "Article de Blog", en: "Blog Post" },
            { key: "social", fr: "Post Réseaux Sociaux", en: "Social Media Post" },
            { key: "script", fr: "Script de présentation", en: "Presentation Script" },
            { key: "outline", fr: "Plan détaillé", en: "Detailed Outline" },
            { key: "code", fr: "Code Block", en: "Code Block" },
            { key: "json", fr: "JSON", en: "JSON" }
        ];

        let state = { lang: 'fr', role: "", task: "", context: "", toneKey: "", formatKey: "", constraints: "", feedbackLoop: false, files: [], instructions: [""] };
        let currentTab = 'markdown';

        document.addEventListener('DOMContentLoaded', () => {
            window.scrollTo(0, 0);
            if('scrollRestoration' in history) history.scrollRestoration = 'manual';

            const browserLang = navigator.language || navigator.userLanguage; 
            if (browserLang.startsWith('en')) state.lang = 'en';

            renderOptions();
            applyLanguage();
            addInstruction();
            updateOutput();
        });

        function showMobileTab(viewName) {
            const editorPanel = document.getElementById('panel-editor');
            const previewPanel = document.getElementById('panel-preview');
            const btnEditor = document.getElementById('nav-btn-editor');
            const btnPreview = document.getElementById('nav-btn-preview');

            if (viewName === 'editor') {
                editorPanel.classList.remove('hidden'); editorPanel.classList.add('flex');
                previewPanel.classList.add('hidden'); previewPanel.classList.remove('flex');
                btnEditor.classList.add('active'); btnPreview.classList.remove('active');
            } else {
                editorPanel.classList.add('hidden'); editorPanel.classList.remove('flex');
                previewPanel.classList.remove('hidden'); previewPanel.classList.add('flex');
                btnEditor.classList.remove('active'); btnPreview.classList.add('active');
            }
        }

        function toggleLanguage() {
            state.lang = state.lang === 'fr' ? 'en' : 'fr';
            applyLanguage(); renderOptions(); updateOutput();
        }

        function applyLanguage() {
            const t = translations[state.lang];
            document.getElementById('lang-display').innerText = state.lang.toUpperCase();
            
            const map = {
                'lbl-role': 'lbl_role', 'lbl-task': 'lbl_task', 'lbl-context': 'lbl_context',
                'lbl-header-format': 'lbl_header_format', 'lbl-tone': 'lbl_tone', 'lbl-format': 'lbl_format',
                'lbl-constraints': 'lbl_constraints', 'lbl-header-files': 'lbl_header_files',
                'lbl-header-instructions': 'lbl_header_instructions', 'lbl-feedback': 'lbl_feedback',
                'txt-feedback-help': 'txt_feedback_help',
                'lbl-preview': 'lbl_preview', 'copy-btn-text': 'btn_copy', 'lbl-generated': 'lbl_generated',
                'txt-toast': 'txt_toast', 'lbl-nav-edit': 'lbl_nav_edit', 'lbl-nav-view': 'lbl_nav_view',
                'lbl-developed': 'lbl_developed', 'lbl-tip': 'lbl_tip'
            };

            for (const [id, key] of Object.entries(map)) {
                const el = document.getElementById(id);
                if(el && t[key]) el.innerText = t[key];
            }
            
            // Mobile Specific labels
            document.querySelectorAll('.lbl-developed-mobile').forEach(e => e.innerText = t.lbl_developed);
            document.querySelectorAll('.lbl-tip-mobile').forEach(e => e.innerText = t.lbl_tip);

            document.getElementById('role').placeholder = t.ph_role;
            document.getElementById('task').placeholder = t.ph_task;
            document.getElementById('context').placeholder = t.ph_context;
            document.getElementById('constraints').placeholder = t.ph_constraints;
            document.getElementById('txt-dropzone').innerHTML = t.txt_dropzone;
            document.getElementById('txt-file-warning').innerHTML = t.txt_file_warning;
        }

        function renderOptions() {
            document.getElementById('tone').innerHTML = toneOptions.map(o => `<option value="${o.key}" ${state.toneKey === o.key ? 'selected' : ''}>${o[state.lang]}</option>`).join('');
            document.getElementById('format').innerHTML = formatOptions.map(o => `<option value="${o.key}" ${state.formatKey === o.key ? 'selected' : ''}>${o[state.lang]}</option>`).join('');
        }

        function updateOutput() {
            state.role = document.getElementById('role').value;
            state.task = document.getElementById('task').value;
            state.context = document.getElementById('context').value;
            state.toneKey = document.getElementById('tone').value;
            state.formatKey = document.getElementById('format').value;
            state.constraints = document.getElementById('constraints').value;
            state.feedbackLoop = document.getElementById('feedback-loop').checked;
            
            const inputs = document.querySelectorAll('#instructions-container input');
            state.instructions = Array.from(inputs).map(i => i.value).filter(v => v.trim() !== "");

            const hasFiles = state.files.length > 0;
            document.getElementById('file-warning').classList.toggle('hidden', !hasFiles);

            const md = generateMarkdown();
            document.getElementById('markdown-content').innerText = md;
            
            const json = generateJSON();
            document.getElementById('json-content').innerHTML = syntaxHighlight(JSON.stringify(json, null, 2));
        }

        function generateMarkdown() {
            const t = translations[state.lang];
            let parts = [];
            if(state.role) parts.push(`${t.prompt_you_are} **${state.role}**.`);
            if(state.task) parts.push(`${t.prompt_task} ${state.task}`);
            if(state.context) parts.push(`**${t.prompt_context}** ${state.context}`);
            
            if(state.toneKey) parts.push(`${t.prompt_tone} ${toneOptions.find(o=>o.key===state.toneKey)[state.lang]}.`);
            if(state.formatKey) parts.push(`${t.prompt_format} ${formatOptions.find(o=>o.key===state.formatKey)[state.lang]}.`);
            if(state.constraints) parts.push(`${t.prompt_constraints} ${state.constraints}.`);
            
            if(state.files.length) {
                parts.push(`\n${t.prompt_files}`);
                state.files.forEach(f => parts.push(`- ${t.prompt_file_item}${f.name}]`));
            }
            if(state.instructions.length && state.instructions[0]) {
                parts.push(`\n**${t.prompt_instructions}**`);
                state.instructions.forEach(i => parts.push(`- ${i}`));
            }
            if(state.feedbackLoop) parts.push(t.prompt_feedback);

            return parts.join('\n\n');
        }

        function generateJSON() {
            return {
                meta: { lang: state.lang }, role: state.role, task: state.task, context: state.context,
                config: { tone: state.toneKey, format: state.formatKey, constraints: state.constraints, feedback: state.feedbackLoop },
                attachments: state.files.map(f=>f.name), instructions: state.instructions
            };
        }

        function handleFiles(files) { state.files = [...state.files, ...Array.from(files)]; renderFiles(); updateOutput(); }
        function renderFiles() {
            const c = document.getElementById('file-list'); c.innerHTML = '';
            state.files.forEach((f, i) => {
                c.innerHTML += `<div class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs flex items-center gap-2"><i class="fas fa-file"></i> ${f.name} <button onclick="removeFile(${i})" class="text-red-500 hover:text-red-700">&times;</button></div>`;
            });
        }
        function removeFile(i) { state.files.splice(i, 1); renderFiles(); updateOutput(); }
        
        function addInstruction() {
            const c = document.getElementById('instructions-container');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 animate-[fadeIn_0.2s]';
            div.innerHTML = `<input type="text" class="flex-grow bg-white border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-500" oninput="updateOutput()"><button onclick="this.parentElement.remove(); updateOutput()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>`;
            c.appendChild(div);
        }

        function switchTab(tab) {
            currentTab = tab;
            const isMd = tab === 'markdown';
            document.getElementById('view-markdown').classList.toggle('hidden', !isMd);
            document.getElementById('view-json').classList.toggle('hidden', isMd);
            document.getElementById('tab-btn-markdown').className = isMd ? 'tab-active px-4 py-2 rounded-full text-xs md:text-sm transition-all flex items-center gap-2' : 'tab-inactive px-4 py-2 rounded-full text-xs md:text-sm transition-all flex items-center gap-2';
            document.getElementById('tab-btn-json').className = !isMd ? 'tab-active px-4 py-2 rounded-full text-xs md:text-sm transition-all flex items-center gap-2' : 'tab-inactive px-4 py-2 rounded-full text-xs md:text-sm transition-all flex items-center gap-2';
            updateOutput();
        }

        function copyCurrentContent() {
            const txt = currentTab === 'markdown' ? document.getElementById('markdown-content').innerText : document.getElementById('json-content').innerText;
            navigator.clipboard.writeText(txt).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 2000);
            });
        }

        function resetForm() {
            if(confirm(state.lang === 'fr' ? "Tout effacer ?" : "Clear all?")) {
                document.querySelectorAll('input, textarea, select').forEach(e => { if(e.type==='checkbox') e.checked=false; else e.value=''; });
                state.files = []; state.instructions = [""];
                renderFiles(); document.getElementById('instructions-container').innerHTML = ''; addInstruction(); renderOptions(); updateOutput();
            }
        }

        function syntaxHighlight(json) {
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) cls = /:$/.test(match) ? 'json-key' : 'json-string';
                else if (/true|false/.test(match)) cls = 'json-boolean';
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>
</html>
